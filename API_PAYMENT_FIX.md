# إصلاح مشكلة خطأ 500 في API الدفع

## المشكلة:
يحدث خطأ 500 (Internal Server Error) عند إرسال طلب الدفع، مع رسالة الخطأ:
```
فشل حفظ طلب الدفع
```

## أسباب المشكلة:
1. **مشكلة في هيكل قاعدة البيانات**: 
   - جدول `subscriptions` قد لا يكون موجوداً
   - محاولة إنشاء الجدول في وقت تنفيذ الطلب غير موثوقة

2. **عدم معالجة الأخطاء بشكل مناسب**:
   - عدم وجود طريقة بديلة للحفظ في حالة فشل الحفظ الرئيسي
   - استخدام مباشر لـ RPC بدون معالجة مناسبة للأخطاء

3. **عدم التحقق من وجود الجداول**:
   - عدم التحقق من وجود جداول الاشتراكات والإشعارات قبل استخدامها

## الإصلاحات التي تم إجراؤها:

### 1. تحسين معالجة الأخطاء:
- إضافة هيكل `try-catch` مناسب لكل عملية قاعدة بيانات
- إضافة سجلات تفصيلية لتتبع مصدر الخطأ

### 2. إضافة نظام حفظ بديل:
- إنشاء جدول `subscription_requests` كحل بديل لحفظ طلبات الاشتراك
- الحفظ في الجدول البديل إذا فشل الحفظ في الجدول الرئيسي

### 3. التحقق من وجود الجداول:
- التحقق من وجود الجداول قبل محاولة الإدخال فيها
- عدم محاولة إنشاء الجداول في وقت تنفيذ الطلب

### 4. تحسينات أخرى:
- تخطي استخدام `pg_reload_conf()` لتجنب أخطاء الصلاحيات
- معالجة أفضل للبيانات المرسلة إلى قاعدة البيانات
- إضافة ملف SQL لإنشاء هيكل قاعدة البيانات المطلوب

## كيفية تطبيق الإصلاح:

1. **تنفيذ سكريبت قاعدة البيانات**:
   - قم بتنفيذ الملف `FIX_DB_SCHEMA.sql` لإنشاء الجداول المطلوبة

2. **التحقق من صحة البيانات**:
   - تأكد من صحة معرف المستخدم المرسل
   - تأكد من صحة بيانات الباقة

3. **اختبار الوظيفة**:
   - قم باختبار إرسال طلب دفع جديد
   - تحقق من البيانات في جدول `payments` و `subscriptions`

## ملاحظات إضافية:

- يجب التأكد من إعداد قاعدة البيانات بشكل صحيح قبل تشغيل التطبيق
- يمكن تحسين النظام من خلال إضافة عمليات ترحيل قاعدة البيانات المناسبة
- في حالة استمرار المشكلة، يمكن فحص سجلات الخادم للحصول على المزيد من التفاصيل
