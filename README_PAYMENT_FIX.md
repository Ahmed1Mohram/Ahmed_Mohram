# إصلاح مشكلة API طلب الدفع

## الإصلاحات التي تم إجراؤها

### 1. تبسيط عملية الدفع
- تمت إعادة كتابة API طلب الدفع ليكون أكثر بساطة وموثوقية
- تم التخلي عن محاولة إنشاء الجداول في وقت التشغيل
- تم إضافة معالجة أخطاء أفضل وسجلات تفصيلية

### 2. استخدام جدول بديل أبسط
- تم استخدام جدول `subscription_requests` بدلاً من جدول `subscriptions` المعقد
- يتم تخزين تفاصيل الطلب في حقل JSON للمرونة والتوافق المستقبلي

### 3. تحسين معالجة ملف الإيصال
- تمت إضافة فحوصات إضافية لنوع وحجم الملف
- تم تبسيط عملية رفع الصورة والحصول على الرابط

### 4. تحسين معالجة الأخطاء
- إضافة تفاصيل أكثر في رسائل الخطأ
- إرجاع أكواد وتفاصيل محددة لتسهيل تتبع المشكلات

## كيفية الاختبار
1. قم بإرسال طلب دفع جديد مع إرفاق صورة إيصال
2. تحقق من وجود السجل الجديد في جدول `subscription_requests`
3. تأكد من تحديث بيانات المستخدم بشكل صحيح

## الهيكل الجديد للبيانات
- جدول `subscription_requests`: يحفظ جميع طلبات الاشتراك الجديدة
- تحديث جدول `users`: يحفظ آخر حالة اشتراك للمستخدم
- جدول `notifications`: يرسل إشعارات للمدير عند استلام طلبات جديدة

## ملاحظات هامة
- تأكد من وجود الجداول المطلوبة في قاعدة البيانات (استخدم `FIX_DB_SCHEMA.sql`)
- إذا استمرت المشكلة، استخدم `FIX_PAYMENTS_TABLE.sql` لإضافة عمود `receipt_url` إلى جدول `payments`
- تم تعزيز السجلات التشخيصية للمساعدة في تتبع المشكلات المستقبلية
