# دليل تصحيح أخطاء واجهة برمجة التطبيقات للدفع

## الأخطاء الحالية:

1. **خطأ في حفظ اختيار الباقة**:
   ```
   Could not find the 'selected_package_id' column of 'users' in the schema cache
   ```
   ✅ تم إصلاح هذا الخطأ بإزالة محاولة تحديث العمود غير الموجود.

2. **خطأ في API طلب الدفع (HTTP 400)**:
   ```
   POST http://localhost:3000/api/payment-request 400 (Bad Request)
   ```
   تم تحسين عرض رسائل الخطأ، لكن المشكلة الأساسية لا تزال موجودة.

## خطوات تصحيح الأخطاء:

### 1. إضافة الأعمدة المفقودة (اختياري):

قمنا بإنشاء ملف `ADD_COLUMNS_TO_USERS.sql` لإضافة الأعمدة المفيدة التي تم محاولة استخدامها:
- `selected_package_id`
- `device_info` (كـ JSONB)
- `login_count` و `last_login`

### 2. تشخيص خطأ طلب الدفع:

#### أ. تحقق من البيانات المرسلة:
قمنا بتعديل `subscription/page.tsx` لعرض تفاصيل الخطأ المستلمة من الخادم.

#### ب. المشاكل المحتملة:

1. **ملف الإيصال**:
   - التحقق من أن حجم الإيصال أقل من 5 ميجابايت
   - التحقق من نوع الملف (يجب أن يكون صورة)
   - محاولة إرسال طلب دفع بدون إيصال (لطرق الدفع الأخرى)

2. **حاوية تخزين Supabase**:
   - التحقق من وجود حاوية `payment_receipts` في Supabase
   - التحقق من الصلاحيات للوصول إلى التخزين

3. **التحقق من الحقول المطلوبة**:
   - التأكد من أن جميع الحقول المطلوبة في API مرسلة بشكل صحيح
   - التحقق من تطابق أسماء الحقول المرسلة مع الحقول المتوقعة في API

### 3. مراقبة السجلات على الخادم:

أضفنا المزيد من سجلات التشخيص في كلا الملفين:
- `save-package-selection/route.ts`: لتوضيح البيانات المستلمة والأخطاء
- `subscription/page.tsx`: لعرض تفاصيل الخطأ المستلمة من الخادم

## توصيات إضافية:

1. **اختبار الواجهات البرمجية مباشرة**:
   استخدم أدوات مثل Postman لإرسال طلبات مباشرة إلى الواجهات البرمجية للتحقق من استجاباتها بشكل مستقل.

2. **التحقق من قاعدة البيانات**:
   استخدم ملف `GET_TABLE_SCHEMA.sql` للتحقق من هيكل الجداول والتأكد من وجود الأعمدة المطلوبة.

3. **إضافة معالجة أخطاء أفضل**:
   تم تحسين معالجة الأخطاء في الواجهة الأمامية للحصول على رسائل أكثر تفصيلاً من الخادم.

## خطوات المتابعة:

1. قم بتنفيذ سكريبت `ADD_COLUMNS_TO_USERS.sql` إذا كنت تريد إضافة الأعمدة المفقودة (اختياري)
2. اختبر اختيار الباقة مرة أخرى بعد التعديلات
3. جرب طرق دفع مختلفة ومراقبة السجلات للحصول على مزيد من التفاصيل
4. راقب وحدة التحكم في المتصفح والسجلات على الخادم للحصول على معلومات أكثر تفصيلاً عن الأخطاء
